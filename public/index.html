<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Disappointment Mutual Exchange</title>
  <style>
    /* ---------------- GLOBAL ---------------- */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
    body { background: #0b0b0b; color: #fff; }
    a { color: inherit; text-decoration: none; }

    /* ---------------- HEADER ---------------- */
    header { display: flex; justify-content: space-between; padding: 10px 20px; background: #0f0f0f; border-bottom: 1px solid #222; }
    header h1 { font-size: 20px; color: #f0b90b; }
    .balances { display: flex; gap: 15px; align-items: center; }

    /* ---------------- MAIN LAYOUT ---------------- */
    .container { display: flex; height: calc(100vh - 50px); }
    .sidebar { width: 200px; background: #111; padding: 15px; border-right: 1px solid #222; overflow-y: auto; }
    .main { flex: 1; display: flex; flex-direction: column; }

    /* ---------------- PAIR SELECT & CHART ---------------- */
    .pair-selector { background: #0f0f0f; padding: 10px; border-bottom: 1px solid #222; display: flex; gap: 10px; }
    select { background: #111; color: #fff; border: 1px solid #333; padding: 5px; }

    #chart { flex: 1; background: #0b0b0b; margin: 10px; border: 1px solid #222; }

    /* ---------------- ORDERBOOK/TRADES ---------------- */
    .market-info { display: flex; gap: 10px; margin: 10px; flex: 1; }
    .orderbook, .trades { flex: 1; background: #111; border: 1px solid #222; overflow-y: auto; padding: 10px; }
    .orderbook h2, .trades h2 { font-size: 14px; margin-bottom: 5px; color: #f0b90b; }

    table { width: 100%; font-size: 12px; border-collapse: collapse; }
    th, td { padding: 3px; text-align: right; }
    th { color: #aaa; border-bottom: 1px solid #222; }
    .buy { color: #00b894; }
    .sell { color: #d63031; }

    /* ---------------- ORDER FORM ---------------- */
    .order-form { display: flex; gap: 10px; margin: 10px; }
    .order-form div { flex: 1; display: flex; flex-direction: column; }
    .order-form input, .order-form button { padding: 5px; margin-top: 5px; border: 1px solid #333; background: #111; color: #fff; }
    .order-form button.buy { background: #00b894; border: none; cursor: pointer; }
    .order-form button.sell { background: #d63031; border: none; cursor: pointer; }

  </style>
</head>
<body>

<header>
  <h1>DME Exchange</h1>
  <div class="balances">
    <span>USDT: <b id="bal-usdt">0</b></span>
    <span>BTC: <b id="bal-btc">0</b></span>
    <span>ETH: <b id="bal-eth">0</b></span>
  </div>
</header>

<div class="container">
  <div class="sidebar">
    <h2>Wallet</h2>
    <ul id="wallet-list"></ul>
  </div>

  <div class="main">
    <div class="pair-selector">
      <label>Pair:
        <select id="pair-select">
          <option value="BTCUSDT">BTC/USDT</option>
          <option value="ETHUSDT">ETH/USDT</option>
          <option value="SOLUSDT">SOL/USDT</option>
          <option value="BNBUSDT">BNB/USDT</option>
          <option value="ADAUSDT">ADA/USDT</option>
        </select>
      </label>
      <span>Price: <b id="current-price">0</b></span>
    </div>

    <div id="chart">[Chart Placeholder]</div>

    <div class="market-info">
      <div class="orderbook">
        <h2>Order Book</h2>
        <table>
          <thead><tr><th>Price</th><th>Amount</th></tr></thead>
          <tbody id="bids"></tbody>
          <tbody id="asks"></tbody>
        </table>
      </div>

      <div class="trades">
        <h2>Recent Trades</h2>
        <table>
          <thead><tr><th>Price</th><th>Amount</th></tr></thead>
          <tbody id="trades"></tbody>
        </table>
      </div>
    </div>

    <div class="order-form">
      <div>
        <label>Buy Price</label>
        <input type="number" id="buy-price">
        <label>Amount</label>
        <input type="number" id="buy-amount">
        <button class="buy" id="buy-btn">Buy</button>
      </div>
      <div>
        <label>Sell Price</label>
        <input type="number" id="sell-price">
        <label>Amount</label>
        <input type="number" id="sell-amount">
        <button class="sell" id="sell-btn">Sell</button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPair = 'BTCUSDT';

  async function fetchBalance() {
    const res = await fetch('/api/balance?username=test');
    const bal = await res.json();
    document.getElementById('bal-usdt').textContent = bal.USDT.toFixed(2);
    document.getElementById('bal-btc').textContent = bal.BTC.toFixed(6);
    document.getElementById('bal-eth').textContent = bal.ETH.toFixed(6);
    // Sidebar list
    const walletList = document.getElementById('wallet-list');
    walletList.innerHTML = '';
    for (let k in bal) {
      const li = document.createElement('li');
      li.textContent = `${k}: ${bal[k].toFixed(6)}`;
      walletList.appendChild(li);
    }
  }

  async function fetchPrice() {
    const res = await fetch('/api/prices');
    const prices = await res.json();
    document.getElementById('current-price').textContent = prices[currentPair].toFixed(2);
  }

  async function fetchOrderBook() {
    const res = await fetch(`/api/orderbook?pair=${currentPair}`);
    const data = await res.json();
    const bidsEl = document.getElementById('bids');
    const asksEl = document.getElementById('asks');
    bidsEl.innerHTML = '';
    asksEl.innerHTML = '';
    data.bids.slice(-10).reverse().forEach(o => bidsEl.innerHTML += `<tr><td class="buy">${o.price}</td><td>${o.amount}</td></tr>`);
    data.asks.slice(0,10).forEach(o => asksEl.innerHTML += `<tr><td class="sell">${o.price}</td><td>${o.amount}</td></tr>`);
  }

  async function fetchTrades() {
    const res = await fetch('/api/trades');
    const data = await res.json();
    const tradesEl = document.getElementById('trades');
    tradesEl.innerHTML = '';
    data.trades.slice(-10).reverse().forEach(t => tradesEl.innerHTML += `<tr><td>${t.price}</td><td>${t.amount}</td></tr>`);
  }

  document.getElementById('pair-select').addEventListener('change', e => { currentPair = e.target.value; });

  document.getElementById('buy-btn').addEventListener('click', async () => {
    const price = parseFloat(document.getElementById('buy-price').value);
    const amount = parseFloat(document.getElementById('buy-amount').value);
    await fetch('/api/orders', {
      method: 'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({username:'test', pair: currentPair, side:'buy', price, amount})
    });
    fetchBalance(); fetchOrderBook(); fetchTrades();
  });

  document.getElementById('sell-btn').addEventListener('click', async () => {
    const price = parseFloat(document.getElementById('sell-price').value);
    const amount = parseFloat(document.getElementById('sell-amount').value);
    await fetch('/api/orders', {
      method: 'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({username:'test', pair: currentPair, side:'sell', price, amount})
    });
    fetchBalance(); fetchOrderBook(); fetchTrades();
  });

  function refresh() {
    fetchBalance();
    fetchPrice();
    fetchOrderBook();
    fetchTrades();
  }

  setInterval(refresh, 1500);
  refresh();
</script>

</body>
</html>
