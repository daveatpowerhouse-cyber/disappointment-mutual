<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mutual Exchange</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f2f2f2; }
    header { background: #333; color: #fff; padding: 1rem; text-align: center; }
    main { padding: 1rem; }
    input, button, select { padding: 0.5rem; margin: 0.25rem; }
    #loginForm, #registerForm, #exchange { margin-bottom: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    #prices { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
    .price-card { background: #fff; padding: 0.5rem 1rem; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <header>
    <h1>Mutual Exchange</h1>
  </header>
  <main>
    <div id="auth">
      <h2>Login</h2>
      <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>

      <h2>Register</h2>
      <form id="registerForm">
        <input type="text" id="registerUsername" placeholder="Username" required>
        <input type="password" id="registerPassword" placeholder="Password" required>
        <button type="submit">Register</button>
      </form>
    </div>

    <div id="exchange" style="display:none;">
      <h2>Balances</h2>
      <div id="balances"></div>

      <h2>Prices</h2>
      <div id="prices"></div>

      <h2>Place Order</h2>
      <form id="orderForm">
        <select id="pairSelect">
          <option value="BTCUSDT">BTC/USDT</option>
          <option value="ETHUSDT">ETH/USDT</option>
          <option value="SOLUSDT">SOL/USDT</option>
          <option value="BNBUSDT">BNB/USDT</option>
          <option value="ADAUSDT">ADA/USDT</option>
          <option value="XRPUSDT">XRP/USDT</option>
          <option value="DOGEUSDT">DOGE/USDT</option>
          <option value="DOTUSDT">DOT/USDT</option>
          <option value="AVAXUSDT">AVAX/USDT</option>
        </select>
        <select id="sideSelect">
          <option value="buy">Buy</option>
          <option value="sell">Sell</option>
        </select>
        <input type="number" step="0.0001" id="priceInput" placeholder="Price" required>
        <input type="number" step="0.0001" id="amountInput" placeholder="Amount" required>
        <button type="submit">Place Order</button>
      </form>

      <h2>Order Book</h2>
      <table>
        <thead>
          <tr><th>Side</th><th>Price</th><th>Amount</th></tr>
        </thead>
        <tbody id="orderbook"></tbody>
      </table>

      <h2>Recent Trades</h2>
      <table>
        <thead>
          <tr><th>Pair</th><th>Side</th><th>Price</th><th>Amount</th></tr>
        </thead>
        <tbody id="trades"></tbody>
      </table>
    </div>
  </main>

  <script>
    let currentUser = null;

    async function fetchPrices() {
      const res = await fetch('/api/prices');
      const data = await res.json();
      const pricesDiv = document.getElementById('prices');
      pricesDiv.innerHTML = '';
      Object.keys(data).forEach(pair => {
        const card = document.createElement('div');
        card.className = 'price-card';
        card.textContent = pair + ': ' + data[pair].toFixed(4);
        pricesDiv.appendChild(card);
      });
    }

    async function fetchBalances() {
      const res = await fetch('/api/balance?username=' + currentUser.username);
      const data = await res.json();
      const balancesDiv = document.getElementById('balances');
      balancesDiv.innerHTML = '';
      for (const asset in data) {
        balancesDiv.innerHTML += `<div>${asset}: ${data[asset]}</div>`;
      }
    }

    async function fetchOrderBook(pair) {
      const res = await fetch('/api/orderbook?pair=' + pair);
      const data = await res.json();
      const tbody = document.getElementById('orderbook');
      tbody.innerHTML = '';
      data.bids.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>Buy</td><td>${o.price}</td><td>${o.amount}</td>`;
        tbody.appendChild(tr);
      });
      data.asks.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>Sell</td><td>${o.price}</td><td>${o.amount}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function fetchTrades() {
      const res = await fetch('/api/trades');
      const data = await res.json();
      const tbody = document.getElementById('trades');
      tbody.innerHTML = '';
      data.trades.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.pair}</td><td>${t.side}</td><td>${t.price}</td><td>${t.amount}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username, password})
      });
      const data = await res.json();
      if (data.success) {
        currentUser = data.user;
        document.getElementById('auth').style.display = 'none';
        document.getElementById('exchange').style.display = 'block';
        initExchange();
      } else {
        alert(data.error);
      }
    });

    document.getElementById('registerForm').addEventListener('submit', async e => {
      e.preventDefault();
      const username = document.getElementById('registerUsername').value;
      const password = document.getElementById('registerPassword').value;
      const res = await fetch('/api/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username, password})
      });
      const data = await res.json();
      if (data.success) {
        alert('Registered successfully! You can now log in.');
      } else {
        alert(data.error);
      }
    });

    document.getElementById('orderForm').addEventListener('submit', async e => {
      e.preventDefault();
      const pair = document.getElementById('pairSelect').value;
      const side = document.getElementById('sideSelect').value;
      const price = parseFloat(document.getElementById('priceInput').value);
      const amount = parseFloat(document.getElementById('amountInput').value);
      const res = await fetch('/api/orders', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username: currentUser.username, pair, side, price, amount})
      });
      const data = await res.json();
      if (data.success) {
        fetchBalances();
        fetchOrderBook(pair);
        fetchTrades();
      } else {
        alert(data.error);
      }
    });

    function initExchange() {
      fetchBalances();
      fetchPrices();
      fetchTrades();
      fetchOrderBook(document.getElementById('pairSelect').value);
      setInterval(() => {
        fetchPrices();
        fetchBalances();
        fetchTrades();
        fetchOrderBook(document.getElementById('pairSelect').value);
      }, 2000);
    }
  </script>
</body>
</html>
